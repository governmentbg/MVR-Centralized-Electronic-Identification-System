#!/bin/bash
set -e

LOCAL_VERSION_FILE="VERSION"
REMOTE_BRANCH="origin/dev"

if [ ! -f "$LOCAL_VERSION_FILE" ]; then
  echo "VERSION file not found locally."
  exit 1
fi

LOCAL_VERSION=$(cat "$LOCAL_VERSION_FILE")

# Fetch latest dev without merging
git fetch origin dev > /dev/null

# Get remote VERSION file
REMOTE_VERSION=$(git show ${REMOTE_BRANCH}:VERSION 2>/dev/null || echo "0.0.0")

# Parse versions
version_to_number() {
  IFS='.' read -r MAJOR MINOR FIX <<< "$1"
  echo $((MAJOR * 1000000 + MINOR * 1000 + FIX))
}

LOCAL_NUM=$(version_to_number "$LOCAL_VERSION")
REMOTE_NUM=$(version_to_number "$REMOTE_VERSION")

if [ "$LOCAL_NUM" -le "$REMOTE_NUM" ]; then
  echo "Error: Local version ($LOCAL_VERSION) must be greater than version on $REMOTE_BRANCH ($REMOTE_VERSION)"
  exit 1
fi

echo "Version check passed: $LOCAL_VERSION > $REMOTE_VERSION"
