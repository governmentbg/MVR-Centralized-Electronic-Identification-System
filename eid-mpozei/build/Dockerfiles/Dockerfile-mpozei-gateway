FROM alpine:edge

LABEL authors="Strahil vitkov <strahil.vitkov@bul-si.bg>"

RUN apk --no-cache add bash openjdk17 curl ttf-dejavu
#openjdk17-jre

RUN set -x \
    && addgroup mpozei \
    && adduser -S -G mpozei -h /home/mpozei -s /bin/false mpozei \
    && mkdir -p /home/mpozei/logs \
    && mkdir -p /home/mpozei/logs/mpozei-gateway \
    && mkdir -p /home/mpozei/logs/audit/unsigned \
    && chown -R mpozei:mpozei /home/mpozei

COPY src/mpozei-gateway/target/mpozei-gateway.jar /home/mpozei/
#COPY infra/dev/certs/server_cacerts /usr/lib/jvm/java-17-openjdk/lib/security/cacerts
COPY ext-conf/application-gateway.yaml /home/mpozei/config/application-gateway.yaml

WORKDIR /home/mpozei
ENV PATH /home/mpozei:$PATH


# The actions below are in Jenkinsfile
#RUN ["mvnw", "clean"]
#RUN ["mvnw", "test"]
#RUN ["mvnw", "package", "-DskipTests"]

EXPOSE 8094

ENTRYPOINT ["/usr/bin/java"]

ENV SPRING_PROFILES_ACTIVE=logging-dev,logging-test,logging-audit,rabbitmq,keycloak
CMD ["-jar", "-ea", "--add-opens", "java.base/java.time=ALL-UNNAMED", "-Dspring.profiles.active=${SPRING_PROFILES_ACTIVE}", "-Dspring.config.additional-location=file:/home/mpozei/config/application-gateway.yaml", "mpozei-gateway.jar"]

