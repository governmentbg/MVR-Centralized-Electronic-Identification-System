<section class="h-100" *transloco="let t; read: 'modules.services.service-edit'">
    <p-confirmDialog #confirmationDialogRef [style]="{ width: '50vw' }">
        <ng-template pTemplate="footer">
            <p-button
                styleClass="p-button-danger"
                [label]="t('cancelDialogButton')"
                [ariaLabel]="t('cancelDialogButton')"
                (click)="confirmationDialogRef.reject()"></p-button>
            <p-button
                [label]="t('submitDialogButton')"
                [ariaLabel]="t('submitDialogButton')"
                (click)="confirmationDialogRef.accept()"></p-button>
        </ng-template>
    </p-confirmDialog>
    <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
    <div class="d-flex mb-4 align-items-center">
        <h4 class="text-text-default mb-0">
            {{ t('txtTitle') }}
        </h4>
    </div>
    <p-card>
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="col-md-9 col-lg-8 col-xl-7 d-flex flex-column gap-3">
            <!-- Name -->
            <div class="row">
                <div class="d-flex flex-column">
                    <label for="name" class="form-label">
                        {{ t('txtName') }}
                        <span class="text-danger">*</span>
                    </label>
                    <input pInputText id="name" type="text" class="w-100" formControlName="name" />
                </div>
                <app-error-field
                    [formControlInstance]="form.controls.name"
                    translationPrefix="modules.services.service-edit.errors" />
            </div>
            <!-- Description -->
            <div class="d-flex flex-column">
                <label for="name" class="form-label">
                    {{ t('txtDescription') }}
                    <span class="text-danger">*</span>
                </label>
                <textarea class="w-100 p-2" rows="5" pInputTextarea formControlName="description"></textarea>
                <app-error-field
                    [formControlInstance]="form.controls.description"
                    translationPrefix="modules.services.service-edit.errors" />
            </div>
            <!-- IsEmpowerment -->
            <div>
                <label for="isEmpowerment" class="form-label">
                    {{ t('txtIsEmpowerment') }}
                </label>
                <div>
                    <p-checkbox [binary]="true" formControlName="isEmpowerment" inputId="isEmpowerment"></p-checkbox>
                </div>
            </div>
            <!-- Assurance level -->
            <div>
                <label class="form-label">{{ t('txtAssuranceLevel') }} <span class="text-danger">*</span></label>
                <div class="d-flex flex-column gap-2">
                    <div *ngFor="let assuranceLevel of assuranceLevelOptions" class="field-checkbox d-flex gap-2">
                        <p-radioButton
                            [ngModelOptions]="{ standalone: true }"
                            [inputId]="assuranceLevel.value"
                            name="assuranceLevel"
                            [value]="assuranceLevel.value"
                            [(ngModel)]="selectedAssuranceLevel"></p-radioButton>
                        <label [for]="assuranceLevel.value">{{ assuranceLevel.name }}</label>
                    </div>
                </div>
                <div *ngIf="selectedAssuranceLevelIsInvalidForEdit" class="text-danger validation-text">
                    {{ t('errors.invalidAssuranceLevel') }}
                </div>
            </div>
            <!-- Personal data -->
            <div class="d-flex flex-column">
                <label for="personalData" class="form-label"
                    >{{ t('txtPersonalInformation') }} <span class="text-danger">*</span></label
                >
                <p-multiSelect
                    [style]="{ 'min-width': '300px' }"
                    [options]="personalDataOptions"
                    formControlName="personalData"
                    inputId="personalData"
                    optionLabel="name"
                    [filter]="false" />
                <app-error-field
                    [formControlInstance]="form.controls.personalData"
                    translationPrefix="modules.services.service-preview.errors" />
            </div>
            <!-- Scopes -->
            <div formArrayName="scopes" class="mb-4">
                <label class="form-label">
                    {{ t('txtVolume') }}
                    <span class="text-danger" *ngIf="form.controls.isEmpowerment.value">*</span>
                </label>
                <ng-container *ngIf="isLoading">
                    <div class="d-flex flex-column gap-2 mb-2">
                        <p-skeleton width="100%" height="3rem"> </p-skeleton>
                        <p-skeleton width="100%" height="3rem"></p-skeleton>
                        <p-skeleton width="100%" height="3rem"></p-skeleton>
                    </div>
                </ng-container>
                <ng-container *ngIf="!isLoading">
                    <div *ngFor="let scope of scopes.controls; let i = index" class="d-flex flex-column">
                        <div class="d-flex flex-column mb-2">
                            <div class="gap-2 p-inputgroup w-100">
                                <p-autoComplete
                                    [inputId]="i.toString()"
                                    [formControlName]="i"
                                    [dropdown]="true"
                                    styleClass="w-100"
                                    [completeOnFocus]="true"
                                    (completeMethod)="searchSuggestions($event)"
                                    [suggestions]="suggestions"
                                    appendTo="body"></p-autoComplete>

                                <button
                                    *transloco="let globalT; read: 'global'"
                                    (click)="removeScope(i)"
                                    type="button"
                                    pButton
                                    icon="pi pi-times"
                                    [attr.aria-label]="globalT('txtDelete')"
                                    class="p-button-danger p-button-text border-light rounded"></button>
                            </div>
                            <app-error-field
                                [formControlInstance]="form.controls.scopes.controls[i]"
                                translationPrefix="modules.services.service-preview.errors" />
                        </div>
                    </div>
                </ng-container>

                <p-button
                    *ngIf="!serviceScopeQuery.isLoading"
                    [loading]="defaultScopeQuery.isLoading"
                    [disabled]="defaultScopeQuery.isLoading"
                    [label]="t('add')"
                    [ariaLabel]="t('add')"
                    icon="pi pi-plus"
                    [iconPos]="'left'"
                    styleClass="p-button-success"
                    (click)="addScope()">
                </p-button>
                <app-error-field
                    [formControlInstance]="form.controls.scopes"
                    translationPrefix="modules.services.service-preview.errors" />
            </div>
            <div class="d-flex gap-4 mt-4">
                <p-button
                    styleClass="p-button-danger"
                    [label]="t('cancelButton')"
                    [ariaLabel]="t('cancelButton')"
                    (click)="cancelEdit()"></p-button>
                <p-button
                    type="submit"
                    styleClass="p-button-primary"
                    [disabled]="isLoading"
                    [ariaLabel]="t('submit')"
                    [label]="t('submit')"></p-button>
            </div>
        </form>
    </p-card>
</section>
