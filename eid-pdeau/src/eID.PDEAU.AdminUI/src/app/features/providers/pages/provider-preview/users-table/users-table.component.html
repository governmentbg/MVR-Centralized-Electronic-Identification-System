<div class="col" *transloco="let t">
    <div class="d-flex justify-content-end mb-4">
        <p-button
            *ngIf="allowUsersModification"
            styleClass="p-button-success"
            [label]="t('modules.users.usersTable.register')"
            icon="pi pi-plus"
            [ariaLabel]="t('modules.users.usersTable.register')"
            (onClick)="addUser()"></p-button>
    </div>
    <p-table
        #usersTable
        dataKey="id"
        [value]="users || []"
        [tableStyle]="{ 'min-width': '100%' }"
        [rowHover]="true"
        [paginator]="true"
        [totalRecords]="users.length"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        [currentPageReportTemplate]="
            t('global.txtTablePagination', {
                first: '{first}',
                last: '{last}',
                totalRecords: '{totalRecords}'
            })
        "
        [showCurrentPageReport]="true"
        loadingIcon="pi pi-spin pi-spinner"
        sortField="!isAdministrator"
        [sortOrder]="1"
        [rowSelectable]="false"
        [globalFilterFields]="['name', 'email', 'phone']">
        <ng-template pTemplate="caption">
            <div class="table-header d-flex justify-content-end align-items-center">
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input
                        #filterInput
                        pInputText
                        type="text"
                        (input)="globalFilter($event)"
                        placeholder="{{ t('modules.providers.application-preview.users-table.searchPlaceholder') }}" />
                    <button
                        type="button"
                        pButton
                        icon="pi pi-times"
                        (click)="clearGlobalFilter()"
                        [disabled]="!usersTable.hasFilter()"
                        [attr.aria-label]="t('global.txtDelete')"
                        class="p-button-danger p-button-text border-light border-start-0"></button>
                </span>
            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="name" class="text-nowrap">
                    {{ t('modules.providers.application-preview.users-table.txtName') }}
                    <p-sortIcon field="name"></p-sortIcon>
                </th>
                <th pSortableColumn="email" class="text-nowrap">
                    {{ t('modules.providers.application-preview.users-table.txtEmail') }}
                    <p-sortIcon field="email"></p-sortIcon>
                </th>
                <th pSortableColumn="phone" class="text-nowrap">
                    {{ t('modules.providers.application-preview.users-table.txtPhone') }}
                    <p-sortIcon field="phone"></p-sortIcon>
                </th>
                <th pSortableColumn="isAdministrator" class="text-nowrap">
                    {{ t('modules.providers.application-preview.users-table.txtRole') }}
                    <p-sortIcon field="isAdministrator"></p-sortIcon>
                </th>
                <th class="text-nowrap">
                    {{ t('modules.providers.application-preview.users-table.txtAction') }}
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="loadingbody">
            <tr>
                <td>
                    <p-skeleton></p-skeleton>
                </td>
                <td>
                    <p-skeleton></p-skeleton>
                </td>
                <td>
                    <p-skeleton></p-skeleton>
                </td>
                <td>
                    <p-skeleton></p-skeleton>
                </td>
                <td>
                    <p-skeleton></p-skeleton>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
            <tr [ngClass]="{}">
                <td style="max-width: 18rem" [attr.aria-label]="user.name" [title]="user.name">
                    <span class="multiline-ellipsis">{{ user.name }}</span>
                </td>
                <td style="max-width: 18rem" [attr.aria-label]="user.email" [title]="user.email">
                    <span class="multiline-ellipsis">{{ user.email }}</span>
                </td>
                <td style="max-width: 18rem" [attr.aria-label]="user.phone" [title]="user.phone">
                    <span class="multiline-ellipsis">{{ user.phone }}</span>
                </td>
                <td style="max-width: 18rem">
                    <ng-container *ngIf="user.isAdministrator">
                        <span
                            class="d-flex align-items-center"
                            [title]="t('enums.userRole.administrator')"
                            [attr.aria-label]="t('enums.userRole.administrator')">
                            <i class="material-icons-outlined me-3" [innerHTML]="'&#xe7fd;'"> </i>
                            {{ t('enums.userRole.administrator') }}
                        </span>
                    </ng-container>
                    <ng-container *ngIf="!user.isAdministrator">
                        <span
                            class="d-flex align-items-center"
                            [title]="t('enums.userRole.user')"
                            [attr.aria-label]="t('enums.userRole.user')">
                            <i class="material-icons-outlined me-3" [innerHTML]="'&#xe7fd;'"> </i>
                            {{ t('enums.userRole.user') }}
                        </span>
                    </ng-container>
                </td>
                <td style="width: 10rem">
                    <div class="d-flex">
                        <p-button
                            [title]="t('modules.users.usersTable.table.details.previewUser')"
                            [ariaLabel]="t('modules.users.usersTable.table.details.previewUser')"
                            styleClass="p-button-sm p-button-text"
                            (click)="previewAdministratorAction(user)">
                            <i class="material-icons-outlined">&#xf801;</i>
                        </p-button>
                        <p-button
                            [title]="t('modules.users.usersTable.table.details.editUser')"
                            [ariaLabel]="t('modules.users.usersTable.table.details.editUser')"
                            styleClass="p-button-sm p-button-text"
                            *ngIf="allowUsersModification"
                            (click)="editUser(user)">
                            <i class="material-icons-outlined">&#xe3c9;</i>
                        </p-button>
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="5">
                    <span
                        class="d-flex align-items-center flex-column empty-message-container bg-background-light-grey">
                        <img src="/assets/images/noresults.png" [alt]="t('aria.txtLogo')" />
                        <span class="text-text-light" [attr.aria-label]="t('global.txtNoRecordsFound')">
                            {{ t('global.txtNoRecordsFound') }}
                        </span>
                    </span>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <p-dialog
        [(visible)]="showDialog"
        [style]="{ width: '50vw', maxWidth: '700px' }"
        [draggable]="false"
        [resizable]="false"
        [modal]="true">
        <ng-template pTemplate="header">
            <span class="text-xl font-bold text-uppercase">
                {{ !!userToEdit ? t('modules.users.userEdit.title') : t('modules.users.userRegister.title') }}
            </span>
        </ng-template>
        <app-user-form
            *ngIf="showDialog"
            #userForm
            [user]="userToEdit"
            [showFormButtons]="false"
            (submitEvent)="onUserFormSubmit($event)"
            (cancelEvent)="showDialog = false"></app-user-form>
        <ng-template pTemplate="footer">
            <div class="d-flex gap-4">
                <p-button
                    styleClass="p-button-danger"
                    [disabled]="addUserQuery.isLoading || editUserQuery.isLoading"
                    [label]="t('modules.users.userForm.cancelBUtton')"
                    [ariaLabel]="t('modules.users.userForm.cancelBUtton')"
                    (onClick)="userForm.onCancel()"></p-button>
                <p-button
                    [loading]="addUserQuery.isLoading || editUserQuery.isLoading"
                    [label]="t('modules.users.userForm.submitButton')"
                    [ariaLabel]="t('modules.users.userForm.submitButton')"
                    (onClick)="userForm.onSubmit()"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <p-dialog
        [(visible)]="showAdministratorActionsDialog"
        [style]="{ width: '50vw', maxWidth: '700px' }"
        [draggable]="false"
        [resizable]="false"
        [modal]="true">
        <ng-template pTemplate="header">
            <span class="text-xl font-bold text-uppercase">
                {{ t('modules.users.userPreview.details') }}
            </span>
        </ng-template>
        <p-tabView *ngIf="showAdministratorActionsDialog">
            <p-tabPanel [header]="t('modules.users.userPreview.title')">
                <app-preview-field [label]="t('modules.users.userForm.uid')" [value]="userToPreview?.uid" />
                <app-preview-field [label]="t('modules.users.userForm.name')" [value]="userToPreview?.name" />
                <app-preview-field [label]="t('modules.users.userForm.email')" [value]="userToPreview?.email" />
                <app-preview-field [label]="t('modules.users.userForm.phone')" [value]="userToPreview?.phone" />
                <app-preview-field
                    [label]="t('modules.users.userForm.role')"
                    [value]="
                        userToPreview?.isAdministrator ? t('enums.userRole.administrator') : t('enums.userRole.user')
                    " />
            </p-tabPanel>
            <p-tabPanel [header]="t('modules.users.userHistory.txtTitle')">
                <div class="status-history-container" *transloco="let t; read: 'modules.users.userHistory'">
                    <div class="flex flex-col" *ngFor="let history of fetchUserHistoryQuery.data || []; index as idx">
                        <p-divider *ngIf="idx > 0"></p-divider>
                        <div class="col d-flex flex-column p-1 ps-0">
                            <label class="col">{{ t('txtDate') }}:</label>
                            <span class="">{{ history.dateTime | translocoDate }}</span>
                        </div>
                        <div class="col d-flex flex-column p-1 ps-0">
                            <label class="col">{{ t('txtUid') }}:</label>
                            <span class="">{{ history.administratorUid }}</span>
                        </div>
                        <div class="col d-flex flex-column p-1 ps-0">
                            <label class="col">{{ t('txtUser') }}:</label>
                            <span class="">{{ history.administratorFullName }}</span>
                        </div>
                        <div class="col d-flex flex-column p-1 ps-0">
                            <label class="col">{{ t('txtComment') }}:</label>
                            <span class="text-break">{{ history.comment }}</span>
                        </div>
                    </div>
                    <ng-container *ngIf="fetchUserHistoryQuery.data?.length === 0 && !fetchUserHistoryQuery.isLoading">
                        <p *transloco="let t">{{ t('global.txtNoData') }}</p>
                    </ng-container>
                    <div class="text-center">
                        <i
                            *ngIf="fetchUserHistoryQuery.isLoading"
                            class="pi pi-spin pi-spinner text-primary"
                            style="font-size: 2rem"></i>
                    </div>
                </div>
            </p-tabPanel>
        </p-tabView>
    </p-dialog>
</div>
